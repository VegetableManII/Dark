## DarkCache分布式缓存

#### 功能

- LRU缓存淘汰策略


- 单机并发缓存
- HTTP服务端
- 一致性哈希及分布式虚拟节点
- singleflight防止缓存击穿
- Protobuf通信

#### 功能组件和目录结构

- **lru**：

  - 主要成员
    - 双向链表：`container/list`
    - Hash表：`map`
    - OnEvicted(函数指针成员)：当某条记录移除时触发回调函数
  - 主要方法
    - **Get**：通过key获取`*list.Element`，并将其移动到首部，通过类型断言将`*list.Element`转换为节点类型
    - **RemoveOldest**：获取最后一个元素删除（双向链表和hash表中都要删除），更新使用内存大小，调用回调函数如果有的话
    - **Add**：如果已存在则移动到首部，更新使用内存大小,更新hash表对应值；如果不存在，创建节点并插入到首部在hash表中添加并更新使用内存大小，如果内存超过最大限制则调用`RemoveOldest`，直到小于最大限制，最大限制设置为0表示不限制缓存的内存占用大小

- **byteview**：只读数据结构，表示缓存的值，底层为byte数组，提供**ByteSlice**返回缓存数据的拷贝

- **cache**：通过互斥锁实现单机并发访问，对lru进行了加一层锁的封装，`add`和`get`方法对数据的表述均为`byteview`格式，`add`当`lru==nil`时创建实例，延迟初始化。

- **Group**：负责与用户交互以及控制缓存值的存储和获取的流程

  - 主要成员：
    - `name`区分不同缓存空间，即缓存命名空间
    - `Getter`回调的注册可以是函数类型也可以结构体类型，当缓存未命中时回调
    - `cache`并发缓存，使用`singleflight`防止缓存击穿
    - `loader`?????????????????
  - 主要方法：
    - **Get**：返回类型为`ByteView`，封装`cache`的`get`方法，如果没有缓存则回调加载源数据
    - **getLocally**：

- **Getter**接口：回调函数，当缓存不存在时调用用户提供的回调函数去获取数据或做其他处理。持有`Get`方法

  - `Get(key string) ([]byte, error)`方法被定义为`GetterFunc`类型
  - `GetterFunc`实现了`Get`方法，这种函数成为接口函数，在调用时既可以传入结构体也可以传入这种类型的函数作为参数

- **HTTP服务端**：实现节点间的HTTP通信，提供被其他节点访问的能力。

  - 主要成员：
    - `self`本地节点的网络地址，一个节点上还可能提供其他服务
    - `basePath`用于表明节点间通信的地址前缀，规定 `/<basePath>/<groupname>/<key>`
    - `mu`互斥锁
    - `peers`其他节点
    - `httpGetters`每一个节点都对应一个Getter，用于远程获取数据
  - 主要方法：
    - **ServeHTTP**：继承自`net/http/server`实现其核心方法，首先通过判断访问路径的前缀是否是basePath，如果是则解析后面的路径得到group实例，`group.Get(key)`获取缓存数据并将缓存数据通过`w.Write()`作为http响应数据返回。

- 一致性哈希算法：将key值映射到2^32的空间中，首尾相连形成一个环。可以放置节点数量的增删引起缓存雪崩。

  - 计算节点（取节点的名称、编号、和IP地址）的哈希值，放置在环上
  - 计算key的哈希值，放置在换上，顺时针寻找到的第一个节点作为存储数据的节点

  存在的问题：数据倾斜，当节点数量比较少时容易造成节点间负载不平衡。

  - 增设虚拟节点：将实际节点的信息拼接编号生成新的哈希值放置在换上，当顺时针找到虚拟节点时实际保存到这个虚拟节点对应的实际节点，只需要用map来存储实际节点和虚拟节点之间的映射关系。

- **consistenthash**：

  - 主要成员：
    - `hash`Hash算法，计算4字节的哈希值
    - `replicas`虚拟节点的数量
    - `keys`虚拟节点的哈希值有序数组
    - `hashMap`虚拟节点的哈希值和其名字的映射关系
  - 主要方法：
    - **New**：根据自定义虚拟节点数量和自定义哈希算法创建一个表示所有虚拟节点的Map，默认使用`crc32.ChecksumIEEE`摘要算法。
    - **Add**：根据实际节点的个数以及设定的虚拟节点数量创建所有虚拟节点以及他们之间的映射关系。
    - **Get**：根据key的哈希值获得要存储的节点包括虚拟节点和实际节点。查找过程为从环上顺时针查找最近的节点，对有序数组二分查找，注意当找不到时返回的结果不是“-1”而是数组的长度，建议对结果取余使用。

- **peers**：抽象接口，提供远程通信的功能。

  - **PeerPicker**：提供了`PickPeer()`的方法用于根据传入的key找到相应的节点。
  - **PeerGetter**：提供了`Get`方法用于从对应的`group`查找缓存值。在HTTP客户端使用。

- **HTTP客户端**：`httpGetter`继承自`PeerGetter`，实现`Get`方法。